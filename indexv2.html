<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Math Mastery Roadmap — Interactive</title>
  <style>
    :root{
      --bg:#f8fafc;           /* Light background - slate-50 */
      --text:#1e293b;         /* Dark text - slate-800 */
      --muted:#64748b;        /* Muted text - slate-500 */
      --soft:#e2e8f0;         /* Light borders - slate-200 */
      --primary:#3b82f6;      /* Primary blue - blue-500 */
      --primary-weak:#dbeafe; /* Light blue - blue-100 */
      --success:#10b981;      /* Green - emerald-500 */
      --warning:#f59e0b;      /* Amber - amber-500 */
      --card:#ffffff;         /* White cards */
      --locked:#94a3b8;       /* Locked state - slate-400 */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius:12px;
      --border: rgba(226, 232, 240, 0.8);
    }

    /* Dark theme - DEFAULT (More Dark Blue) */
    :root, .dark{
      --bg:#020617;           /* Very dark navy - slate-950 */
      --text:#f1f5f9;         /* Text - soft white */
      --muted:#64748b;        /* Muted text - slate-500 */
      --soft:#1e293b;         /* Borders/dividers - slate-800 */
      --primary:#3b82f6;      /* Primary blue - blue-500 */
      --primary-weak:#1e3a8a; /* Dark blue - blue-800 */
      --success:#10b981;      /* Green - emerald-500 */
      --warning:#f59e0b;      /* Amber - amber-500 */
      --card:#0f172a;         /* Card background - slate-900 */
      --locked:#334155;       /* Locked state - slate-700 */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -2px rgba(0, 0, 0, 0.5);
      --border: rgba(30, 41, 59, 0.8);
    }

    /* Light theme overrides */
    .light{
      --bg:#f8fafc;           /* Light background - slate-50 */
      --text:#1e293b;         /* Dark text - slate-800 */
      --muted:#64748b;        /* Muted text - slate-500 */
      --soft:#e2e8f0;         /* Light borders - slate-200 */
      --primary:#3b82f6;      /* Primary blue - blue-500 */
      --primary-weak:#dbeafe; /* Light blue - blue-100 */
      --success:#10b981;      /* Green - emerald-500 */
      --warning:#f59e0b;      /* Amber - amber-500 */
      --card:#ffffff;         /* White cards */
      --locked:#94a3b8;       /* Locked state - slate-400 */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --border: rgba(226, 232, 240, 0.8);
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; padding:0}
    body{
      background: linear-gradient(135deg, var(--bg) 0%, #0a1628 50%, var(--bg) 100%);
      color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height:1.6;
      transition: all 0.3s ease;
    }

    header{
      position:sticky; top:0; z-index:100; 
      background: rgba(2, 6, 23, 0.95);
      backdrop-filter: blur(12px) saturate(180%);
      border-bottom:1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:20px 24px}
    .header-inner{display:flex; gap:20px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{
      font-size:clamp(22px,3.5vw,36px); 
      margin:0; 
      font-weight:800; 
      background: linear-gradient(135deg, var(--primary), var(--success));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: none;
    }
    .sub{color:var(--muted); font-weight:500; font-size:14px; margin-top:4px}

    .toolbar{display:flex; gap:12px; flex-wrap:wrap}
    button, .btn{
      appearance:none; 
      border:1px solid var(--border); 
      background:var(--card); 
      color:var(--text);
      padding:10px 16px; 
      border-radius:var(--radius); 
      cursor:pointer; 
      font-weight:600; 
      font-size:14px;
      box-shadow:var(--shadow);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    button::before{
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    button:hover{
      background: color-mix(in srgb, var(--card) 90%, var(--primary) 10%);
      border-color:var(--primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    button:hover::before{left: 100%}
    button:active{transform:translateY(0px)}

    .layout{display:grid; grid-template-columns: 320px 1fr; gap:24px; align-items:start; padding:24px 0}

    .card{
      background:var(--card); 
      border:1px solid var(--border); 
      border-radius:var(--radius); 
      box-shadow:var(--shadow); 
      position:relative;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .card::before{
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, transparent 0%, rgba(59, 130, 246, 0.03) 50%, transparent 100%);
      pointer-events: none;
      z-index: 1;
    }
    .card:hover{
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    .card h2{
      margin:0; 
      padding:20px 24px; 
      border-bottom:1px solid var(--border);
      font-weight:700;
      font-size:18px;
      position: relative;
      z-index: 2;
      background: linear-gradient(90deg, var(--primary), var(--success));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .card .content{padding:20px 24px; position: relative; z-index: 2}

    /* Progress Bar */
    .progress{
      height:16px; 
      background: linear-gradient(90deg, var(--soft), color-mix(in srgb, var(--soft) 80%, var(--bg) 20%)); 
      border:1px solid var(--border); 
      border-radius:999px; 
      overflow:hidden;
      position: relative;
    } 
    .bar{
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      border-radius: 999px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .bar::after{
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer{
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Sidebar Checklist */
    .section{margin:20px 0}
    .section h3{
      margin:12px 0 10px; 
      font-size:14px; 
      font-weight:700;
      letter-spacing:.5px; 
      text-transform: uppercase;
      color:var(--muted);
      border-left: 3px solid var(--primary);
      padding-left: 12px;
    }
    .item{
      display:flex; 
      align-items:center; 
      gap:12px; 
      padding:12px 16px; 
      border-radius:var(--radius); 
      border:1px solid transparent;
      margin: 8px 0;
      transition: all 0.2s ease;
      position: relative;
    }
    .item::before{
      content: '';
      position: absolute;
      left: 0; top: 0;
      width: 3px; height: 100%;
      border-radius: 0 var(--radius) var(--radius) 0;
      transition: all 0.2s ease;
    }
    .item.locked{opacity:.6}
    .item.locked::before{background: var(--locked)}
    .item.unlocked{
      background: color-mix(in srgb, var(--primary-weak) 20%, transparent 80%); 
      border-color:color-mix(in srgb, var(--primary) 30%, transparent 70%);
    }
    .item.unlocked::before{background: var(--primary)}
    .item.done{
      background:color-mix(in srgb, var(--success) 20%, transparent 80%); 
      border-color:color-mix(in srgb, var(--success) 30%, transparent 70%);
    }
    .item.done::before{background: var(--success)}
    .item:hover:not(.locked){
      transform: translateX(4px);
      box-shadow: var(--shadow);
    }
    .item label{display:flex; gap:12px; align-items:center; width:100%; cursor:pointer}
    .item .tag{
      font-size:11px; 
      padding:4px 10px; 
      border-radius:999px; 
      background:var(--soft); 
      color:var(--text);
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    input[type="checkbox"]{
      width:20px; height:20px; 
      border-radius: 6px;
      border: 2px solid var(--border);
      background: var(--card);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    input[type="checkbox"]:checked{
      background: var(--success);
      border-color: var(--success);
    }
    input[type="checkbox"].locked{cursor:not-allowed; opacity: 0.5}

    /* Main panels tabs */
    .tabs{display:flex; gap:8px; padding:20px 24px 0; position: relative; z-index: 2}
    .tab{
      padding:12px 20px; 
      border-radius:var(--radius) var(--radius) 0 0; 
      border:1px solid var(--border); 
      border-bottom: none;
      background:color-mix(in srgb, var(--card) 70%, var(--bg) 30%); 
      cursor:pointer; 
      font-weight:600;
      transition: all 0.2s ease;
      position: relative;
    }
    .tab.active{
      background:var(--card); 
      border-color:var(--primary); 
      color:var(--primary);
      transform: translateY(-2px);
    }
    .tab.active::after{
      content: '';
      position: absolute;
      bottom: -1px; left: 0;
      width: 100%; height: 3px;
      background: var(--primary);
    }

    .panels > section{display:none}
    .panels > section.active{display:block}

    /* SVG boards */
    .board{
      width:100%; 
      height:800px; 
      border-top:1px solid var(--border);
      background: linear-gradient(45deg, transparent 24%, rgba(30, 41, 59, 0.1) 25%, rgba(30, 41, 59, 0.1) 26%, transparent 27%, transparent 74%, rgba(30, 41, 59, 0.1) 75%, rgba(30, 41, 59, 0.1) 76%, transparent 77%), linear-gradient(45deg, transparent 24%, rgba(30, 41, 59, 0.1) 25%, rgba(30, 41, 59, 0.1) 26%, transparent 27%, transparent 74%, rgba(30, 41, 59, 0.1) 75%, rgba(30, 41, 59, 0.1) 76%, transparent 77%);
      background-size: 40px 40px;
      background-position: 0 0, 20px 20px;
      overflow: visible;
    } 
    svg{width:100%; height:100%; overflow: visible}

    .node{cursor:pointer; transition: all 0.2s ease}
    .node:hover{transform: scale(1.05)}
    .node rect{
      rx:var(--radius); ry:var(--radius); 
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
      transition: all 0.2s ease;
    }
    .node:hover rect{filter: drop-shadow(0 8px 16px rgba(0,0,0,0.2))}
    .node text{font-size:12px; font-weight:700; fill: var(--text); text-anchor: middle}

    .state-locked rect{fill:var(--soft); stroke:var(--locked); stroke-width:2} 
    .state-unlocked rect{fill:color-mix(in srgb, var(--primary) 20%, var(--card) 80%); stroke:var(--primary); stroke-width:2}
    .state-done rect{fill:color-mix(in srgb, var(--success) 20%, var(--card) 80%); stroke:var(--success); stroke-width:2}

    .edge{stroke:var(--locked); stroke-width:3; transition: all 0.3s ease}
    .edge.unlocked{stroke:var(--primary); stroke-dasharray: 5,5; animation: dash 1s linear infinite}
    .edge.done{stroke:var(--success)}

    @keyframes dash{
      to { stroke-dashoffset: -10 }
    }

    .legend{display:flex; gap:16px; align-items:center; flex-wrap:wrap; color:var(--muted); font-weight: 600}
    .dot{width:16px; height:16px; border-radius:50%; border: 2px solid currentColor}
    .dot.lock{background:var(--soft); border-color:var(--locked)}
    .dot.unlock{background:color-mix(in srgb, var(--primary) 20%, transparent 80%); border-color:var(--primary)}
    .dot.done{background:color-mix(in srgb, var(--success) 20%, transparent 80%); border-color:var(--success)}

    /* Footer */
    footer{border-top:1px solid var(--border); margin-top:32px; background: color-mix(in srgb, var(--card) 50%, transparent 50%)}
    footer .wrap{display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap: wrap}
    .stats{display:flex; gap:20px; color:var(--muted); flex-wrap:wrap; font-weight: 600}

    /* Responsive */
    @media (max-width: 768px) {
      .layout{grid-template-columns: 1fr; gap:16px}
      .header-inner{flex-direction: column; align-items: flex-start; gap: 16px}
      .toolbar{width: 100%; justify-content: center}
    }

    /* Print styles */
    @media print{
      header, .toolbar, .tabs, button{display:none !important}
      .layout{grid-template-columns:1fr; gap:10px; padding:0}
      .board{height:1000px; background: white !important}
      body{background:#fff !important}
      .card{box-shadow: none !important; border: 1px solid #ccc !important}
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar{width: 8px}
    ::-webkit-scrollbar-track{background: var(--bg)}
    ::-webkit-scrollbar-thumb{background: var(--soft); border-radius: 4px}
    ::-webkit-scrollbar-thumb:hover{background: var(--primary)}
  </style>
</head>
<body class="dark">
  <header>
    <div class="wrap header-inner">
      <div>
        <h1>Math Mastery Roadmap</h1>
        <div class="sub">Track prerequisites → unlock topics → conquer calculus, complex variables, Laplace, and linear algebra.</div>
      </div>
      <div class="toolbar">
        <button id="btnTheme" title="Toggle theme">☀️ Light</button>
        <button id="btnExport">📊 Export Progress</button>
        <button id="btnImport">📁 Import Progress</button>
        <button id="btnReset">🔄 Reset</button>
        <button onclick="window.print()">🖨️ Print</button>
      </div>
    </div>
  </header>

  <div class="wrap" style="padding-top:12px">
    <div class="card" style="margin-bottom:20px">
      <div class="content" style="display:flex; gap:24px; align-items:center; flex-wrap:wrap">
        <div style="min-width:300px; flex:1">
          <div style="font-weight:700; margin-bottom:8px; font-size:16px">Overall Progress</div>
          <div class="progress"><div id="progressBar" class="bar"></div></div>
        </div>
        <div class="legend">
          <div style="display:flex; align-items:center; gap:8px"><div class="dot lock"></div> Locked</div>
          <div style="display:flex; align-items:center; gap:8px"><div class="dot unlock"></div> Unlocked</div>
          <div style="display:flex; align-items:center; gap:8px"><div class="dot done"></div> Completed</div>
        </div>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: Checklist -->
      <aside class="card">
        <h2>📋 Checklist & Prerequisites</h2>
        <div class="content" id="checklist"></div>
      </aside>

      <!-- RIGHT: Boards -->
      <main class="card">
        <div class="tabs">
          <div class="tab active" data-tab="flow">📊 Flowchart View</div>
          <div class="tab" data-tab="skill">🎯 Skill Tree View</div>
        </div>
        <div class="panels">
          <section id="panel-flow" class="active">
            <div class="content" style="padding-bottom:16px">
              <p style="margin-top:0; color:var(--muted)">Classic academic flow from foundations → pre-calculus → calculus → complex/Laplace, plus linear algebra & probability side-tracks.</p>
            </div>
            <div class="board"><svg id="svgFlow" viewBox="0 0 1200 800" role="img" aria-label="Flowchart"></svg></div>
          </section>
          <section id="panel-skill">
            <div class="content" style="padding-bottom:16px">
              <p style="margin-top:0; color:var(--muted)">Game-like skill tree: complete prerequisites to unlock new nodes.</p>
            </div>
            <div class="board"><svg id="svgSkill" viewBox="0 0 1200 800" role="img" aria-label="Skill tree"></svg></div>
          </section>
        </div>
      </main>
    </div>

    <footer>
      <div class="wrap">
        <div class="stats" id="stats"></div>
        <div class="sub">✨ Progress saved locally in your browser.</div>
      </div>
    </footer>
  </div>

  <script>
  // ---- THEME ---------------------------------------------------------------
  const THEME_KEY = 'math-roadmap-theme';
  
  function applyTheme(mode){
    const html = document.documentElement;
    const body = document.body;
    
    // Remove all theme classes
    html.classList.remove('dark', 'light');
    body.classList.remove('dark', 'light');
    
    // Add the new theme class
    html.classList.add(mode);
    body.classList.add(mode);
    
    const btn = document.getElementById('btnTheme');
    if(btn){ 
      btn.textContent = (mode==='dark') ? '☀️ Light' : '🌙 Dark'; 
      btn.title = (mode==='dark') ? 'Switch to Light Mode' : 'Switch to Dark Mode';
    }
    
    // Force a repaint to ensure CSS variables are updated
    requestAnimationFrame(() => {
      refreshAll();
    });
  }
  
  function getPreferredTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if(saved === 'dark' || saved === 'light') return saved;
    // Default to dark mode
    return 'dark';
  }
  
  function toggleTheme(){
    const isDark = document.documentElement.classList.contains('dark');
    const next = isDark ? 'light' : 'dark';
    localStorage.setItem(THEME_KEY, next);
    applyTheme(next);
  }
  
  if(window.matchMedia){
    try{
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e)=>{
        if(!localStorage.getItem(THEME_KEY)) applyTheme('dark'); // Keep dark as default
      });
    }catch(_){/* Safari fallback */}
  }

  // ---- DATA MODEL -----------------------------------------------------------
  // Topic IDs and dependencies (DAG). Keep ids stable for saved progress.
  const TOPICS = [
    // Level 1 — Foundations
    {id:'arithmetic', label:'Arithmetic', level:1, prereq:[]},
    {id:'algebra_basics', label:'Algebra Basics', level:1, prereq:['arithmetic']},
    {id:'coord_geo', label:'Coordinate Geometry', level:1, prereq:['algebra_basics']},
    {id:'trig_basics', label:'Trigonometry Basics', level:1, prereq:['coord_geo']},

    // Level 2 — Pre-Calculus
    {id:'adv_algebra', label:'Advanced Algebra', level:2, prereq:['trig_basics']},
    {id:'seq_series', label:'Sequences & Series', level:2, prereq:['adv_algebra']},
    {id:'analytic_geo', label:'Analytic Geometry', level:2, prereq:['seq_series']},
    {id:'trig_adv', label:'Trigonometry Advanced', level:2, prereq:['analytic_geo']},
    {id:'limits', label:'Limits & Continuity', level:2, prereq:['trig_adv']},

    // Level 3 — Calculus Core
    {id:'diff', label:'Differentiation', level:3, prereq:['limits']},
    {id:'integ', label:'Integration', level:3, prereq:['diff']},
    {id:'multi', label:'Multivariable Calculus', level:3, prereq:['integ']},

    // Level 4 — Deeper Analysis
    {id:'cx_numbers', label:'Complex Numbers', level:4, prereq:['multi']},
    {id:'cx_functions', label:'Complex Functions', level:4, prereq:['cx_numbers']},
    {id:'laplace', label:'Laplace Transforms', level:4, prereq:['cx_functions']},

    // Level 5 — Linear Algebra (side chain from Algebra Basics)
    {id:'matrices', label:'Matrices', level:5, prereq:['algebra_basics']},
    {id:'systems', label:'Systems of Equations', level:5, prereq:['matrices']},
    {id:'vectors', label:'Vector Spaces', level:5, prereq:['systems']},
    {id:'eigen', label:'Eigenvalues & Eigenvectors', level:5, prereq:['vectors']},

    // Level 6 — Probability & Statistics (side chain from Algebra Basics)
    {id:'prob', label:'Probability Basics', level:6, prereq:['algebra_basics']},
    {id:'stats', label:'Statistics Foundations', level:6, prereq:['prob']},
  ];

  // Coordinates for FLOW view (grid-like)
  const FLOW_POS = {
    arithmetic:       {x:100,  y:80},
    algebra_basics:   {x:350,  y:80},
    coord_geo:        {x:600,  y:80},
    trig_basics:      {x:850,  y:80},

    adv_algebra:      {x:100,  y:220},
    seq_series:       {x:350,  y:220},
    analytic_geo:     {x:600,  y:220},
    trig_adv:         {x:850,  y:220},
    limits:           {x:1100, y:220},

    diff:             {x:300,  y:380},
    integ:            {x:600,  y:380},
    multi:            {x:900,  y:380},

    cx_numbers:       {x:300,  y:540},
    cx_functions:     {x:600,  y:540},
    laplace:          {x:900,  y:540},

    matrices:         {x:150,  y:540},
    systems:          {x:150,  y:620},
    vectors:          {x:450,  y:620},
    eigen:            {x:750,  y:620},

    prob:             {x:1020, y:540},
    stats:            {x:1020, y:620},
  };

  // Coordinates for SKILL view (clustered tiers)
  const SKILL_POS = {
    arithmetic:       {x:120, y:100},
    algebra_basics:   {x:320, y:100},
    coord_geo:        {x:520, y:100},
    trig_basics:      {x:720, y:100},

    adv_algebra:      {x:220, y:240},
    seq_series:       {x:420, y:240},
    analytic_geo:     {x:620, y:240},
    trig_adv:         {x:820, y:240},
    limits:           {x:1020,y:240},

    diff:             {x:220, y:380},
    integ:            {x:520, y:380},
    multi:            {x:820, y:380},

    cx_numbers:       {x:220, y:520},
    cx_functions:     {x:520, y:520},
    laplace:          {x:820, y:520},

    matrices:         {x:100, y:520},
    systems:          {x:100, y:600},
    vectors:          {x:360, y:600},
    eigen:            {x:620, y:600},

    prob:             {x:1020, y:520},
    stats:            {x:1020, y:600},
  };

  // ---- STATE ---------------------------------------------------------------
  const STORAGE_KEY = 'math-roadmap-progress.v1';
  let progress = loadProgress(); // { [id]: true|false }

  function loadProgress(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
    catch{ return {}; }
  }
  function saveProgress(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(progress)); }

  function isUnlocked(id){
    const topic = TOPICS.find(t=>t.id===id);
    return topic.prereq.every(p=> !!progress[p]);
  }

  // ---- CHECKLIST RENDER ----------------------------------------------------
  function renderChecklist(){
    const container = document.getElementById('checklist');
    container.innerHTML = '';

    const byLevel = new Map();
    TOPICS.forEach(t=>{
      if(!byLevel.has(t.level)) byLevel.set(t.level, []);
      byLevel.get(t.level).push(t);
    });
    const sortedLevels = Array.from(byLevel.keys()).sort((a,b)=>a-b);

    sortedLevels.forEach(lvl=>{
      const sec = document.createElement('div'); sec.className='section';
      const h = document.createElement('h3'); h.textContent = labelForLevel(lvl);
      sec.appendChild(h);

      byLevel.get(lvl).forEach(t=>{
        const unlocked = isUnlocked(t.id);
        const done = !!progress[t.id];
        const row = document.createElement('div');
        row.className = 'item ' + (done? 'done' : unlocked? 'unlocked' : 'locked');

        const lab = document.createElement('label'); lab.setAttribute('for','chk_'+t.id);
        const cb = document.createElement('input'); cb.type='checkbox'; cb.id='chk_'+t.id;
        cb.checked = done; cb.disabled = !unlocked && !done; if(!unlocked && !done) cb.classList.add('locked');
        cb.addEventListener('change', ()=>{ progress[t.id] = cb.checked; saveProgress(); refreshAll(); });

        const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = t.label;
        const tag = document.createElement('span'); tag.className='tag'; tag.textContent = t.prereq.length? `Prereq: ${t.prereq.length}` : 'Start here';

        lab.appendChild(cb); lab.appendChild(name); lab.appendChild(tag);
        row.appendChild(lab);
        sec.appendChild(row);
      });

      container.appendChild(sec);
    });
  }

  function labelForLevel(lvl){
    return {
      1:'Level 1 — Foundations',
      2:'Level 2 — Pre‑Calculus',
      3:'Level 3 — Calculus Core',
      4:'Level 4 — Complex & Laplace',
      5:'Level 5 — Linear Algebra',
      6:'Level 6 — Probability & Statistics',
    }[lvl] || `Level ${lvl}`;
  }

  // ---- SVG HELPERS ---------------------------------------------------------
  function drawBoard(svg, POS){
    while(svg.firstChild) svg.removeChild(svg.firstChild);

    // edges
    TOPICS.forEach(t=>{
      t.prereq.forEach(p=>{
        const a = POS[p], b = POS[t.id];
        if(!a||!b) return;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', a.x+120); line.setAttribute('y1', a.y+28);
        line.setAttribute('x2', b.x);     line.setAttribute('y2', b.y+28);
        const edgeClass = progress[p] && progress[t.id] ? 'edge done' : 
                         progress[p] ? 'edge unlocked' : 'edge';
        line.setAttribute('class', edgeClass);
        svg.appendChild(line);
      });
    });

    // nodes
    TOPICS.forEach(t=>{
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','node ' + (progress[t.id] ? 'state-done' : isUnlocked(t.id) ? 'state-unlocked' : 'state-locked'));
      g.setAttribute('data-id', t.id);

      const {x,y} = POS[t.id];
      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', x); rect.setAttribute('y', y); rect.setAttribute('width', 120); rect.setAttribute('height', 56);

      const text = document.createElementNS('http://www.w3.org/2000/svg','text');
      text.setAttribute('x', x+60); text.setAttribute('y', y+34); text.setAttribute('text-anchor','middle');
      text.textContent = t.label;

      g.appendChild(rect); g.appendChild(text);
      g.addEventListener('click',()=>onNodeClick(t.id));
      svg.appendChild(g);
    });
  }

  function onNodeClick(id){
    const unlocked = isUnlocked(id);
    const done = !!progress[id];
    if(!unlocked && !done) return; // still locked
    progress[id] = !done; saveProgress(); refreshAll();
  }

  // ---- PROGRESS / STATS ----------------------------------------------------
  function refreshProgress(){
    const total = TOPICS.length;
    const done = TOPICS.filter(t=>progress[t.id]).length;
    const unlocked = TOPICS.filter(t=>isUnlocked(t.id) && !progress[t.id]).length;
    const locked = total - done - unlocked;
    const pct = Math.round((done/total)*100);
    
    document.getElementById('progressBar').style.width = pct + '%';

    const stats = document.getElementById('stats');
    stats.innerHTML = `
      <div>✅ Completed: <strong>${done}/${total}</strong></div>
      <div>🔓 Unlocked: <strong>${unlocked}</strong></div>
      <div>🔒 Locked: <strong>${locked}</strong></div>
      <div>📈 Progress: <strong>${pct}%</strong></div>
    `;
  }

  // ---- PANELS / TABS -------------------------------------------------------
  function setupTabs(){
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.dataset.tab;
        document.querySelectorAll('.panels > section').forEach(p=>p.classList.remove('active'));
        document.getElementById('panel-' + name).classList.add('active');
      });
    });
  }

  // ---- EXPORT / IMPORT / RESET --------------------------------------------
  function setupDataButtons(){
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const data = JSON.stringify(progress, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'math-roadmap-progress.json'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('btnImport').addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = () => {
        const file = inp.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const obj = JSON.parse(reader.result);
            progress = obj || {}; saveProgress(); refreshAll();
            alert('Progress imported successfully!');
          }catch(e){ alert('Invalid JSON file. Please check your file and try again.'); }
        };
        reader.readAsText(file);
      };
      inp.click();
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      if(confirm('⚠️ This will reset all your progress. Are you sure?')){ 
        progress = {}; 
        saveProgress(); 
        refreshAll(); 
        alert('Progress has been reset!');
      }
    });
  }

  // ---- RENDER ALL ----------------------------------------------------------
  function refreshBoards(){
    drawBoard(document.getElementById('svgFlow'), FLOW_POS);
    drawBoard(document.getElementById('svgSkill'), SKILL_POS);
  }

  function refreshAll(){
    renderChecklist();
    refreshProgress();
    refreshBoards();
  }

  // ---- INIT ----------------------------------------------------------------
  setupTabs();
  setupDataButtons();
  applyTheme(getPreferredTheme());
  const themeBtn = document.getElementById('btnTheme');
  if(themeBtn) themeBtn.addEventListener('click', toggleTheme);
  refreshAll();

  // Add some loading animation
  document.addEventListener('DOMContentLoaded', () => {
    document.body.style.opacity = '0';
    document.body.style.transform = 'translateY(20px)';
    document.body.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
    
    setTimeout(() => {
      document.body.style.opacity = '1';
      document.body.style.transform = 'translateY(0)';
    }, 100);
  });

  </script>
</body>
</html>